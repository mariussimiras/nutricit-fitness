<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NUTRICIT FITNESS">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e3a8a">
    <title>NUTRICIT FITNESS - Sistema Ibrido</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Mobile Optimizations - CRITICAL FOR iOS & ANDROID */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Prevent zoom on input focus (iOS/Android) */
        input, select, textarea {
            font-size: 16px !important;
            -webkit-user-select: text;
            user-select: text;
        }

        /* Fix Android keyboard viewport issues */
        html {
            height: 100%;
            height: -webkit-fill-available;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #1d4ed8 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            color: #333;
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
        }

        /* Prevent body scroll when keyboard appears (Android) */
        body.keyboard-open {
            position: fixed;
            width: 100%;
        }

        /* Enhanced mobile input handling */
        .form-input, .field-input, .field-select, .field-textarea {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 8px;
            font-size: 16px !important;
            line-height: 1.5;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        /* Specific fixes for mobile inputs */
        .form-input:focus, .field-input:focus, .field-select:focus, .field-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: none !important;
        }

        /* Mobile-specific login container */
        .login-container {
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        /* Touch-friendly buttons */
        .btn, .login-btn, .logout-btn, .nav-btn {
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Improve scrolling on iOS */
        .content, .tab-content {
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
        }

        /* Fix modal positioning on mobile */
        .video-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 95vw;
            max-height: 90vh;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Safe area handling for iOS */
        @supports (padding: max(0px)) {
            .header-content, .nav-content, .content {
                padding-left: max(20px, env(safe-area-inset-left));
                padding-right: max(20px, env(safe-area-inset-right));
            }
            
            .header {
                padding-top: env(safe-area-inset-top);
            }
            
            .content {
                padding-bottom: max(30px, env(safe-area-inset-bottom));
            }
        }

        /* Additional mobile-specific styles */

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            position: relative;
            overflow: hidden;
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #dc2626, #f59e0b, #10b981);
        }

        .logo-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo-icon {
            font-size: 60px;
            color: #dc2626;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .app-title {
            font-size: 32px;
            font-weight: bold;
            color: #1e3a8a;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .app-subtitle {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 15px 20px 15px 50px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: white;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 18px;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(220, 38, 38, 0.3);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .credentials-info {
            background: #f3f4f6;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            border-left: 4px solid #3b82f6;
        }

        .credentials-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .credentials-list {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.6;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-error {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #991b1b;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            color: #1e40af;
        }

        .hidden { 
            display: none !important; 
        }

        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideIn 0.4s ease;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        @keyframes slideIn {
            from { 
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            to { 
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        .sync-icon {
            animation: spin 1s linear infinite;
            font-size: 16px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Pulse effect for important elements */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            50% { 
                transform: scale(1.02);
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
        }

        /* Enhanced card hover effects */
        .client-card, .test-card, .exercise-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .client-card::before, .test-card::before, .exercise-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.5s;
        }

        .client-card:hover::before, .test-card:hover::before, .exercise-card:hover::before {
            left: 100%;
        }

        .client-card:hover, .test-card:hover, .exercise-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.15);
            transform: translateY(-5px);
        }

        /* Professional success indicator */
        .success-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
            animation: slideUp 0.5s ease;
            z-index: 1000;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Enhanced buttons with better feedback */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Premium dashboard stats */
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.08);
            border: 1px solid rgba(59, 130, 246, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #dc2626, #f59e0b, #10b981, #3b82f6);
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        /* Enhanced exercise cards for mobile viewing */
        .exercise-card {
            border-left: 6px solid #dc2626;
            background: linear-gradient(135deg, #ffffff 0%, #fef7ff 100%);
            position: relative;
        }

        .exercise-number {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        /* Enhanced day sections styling */
        .day-section {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 6px solid #3b82f6;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.1);
            transition: all 0.3s ease;
        }

        .day-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(59, 130, 246, 0.15);
        }

        .day-section h4 {
            font-size: 22px;
            font-weight: bold;
            color: #1e3a8a;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            border-bottom: 2px solid rgba(59, 130, 246, 0.1);
            padding-bottom: 10px;
        }

        .exercises-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        /* Video section styling */
        .video-section {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #93c5fd;
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .video-section:hover {
            border-color: #3b82f6;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
        }

        /* Plan header enhancements */
        .plan-header {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid rgba(59, 130, 246, 0.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }

        .plan-title {
            font-size: 24px;
            font-weight: bold;
            color: #1e3a8a;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        /* Enhanced buttons for video playback */
        .btn.video-btn {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
        }

        .btn.video-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30, 64, 175, 0.4);
        }

        /* Success messages enhancement */
        .success-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 18px 30px;
            border-radius: 15px;
            font-weight: 600;
            box-shadow: 0 15px 35px rgba(16, 185, 129, 0.4);
            animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            max-width: 350px;
            backdrop-filter: blur(10px);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* Mobile-optimized exercise cards */
        @media (max-width: 768px) {
            .exercises-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .day-section {
                padding: 20px 15px;
            }
            
            .plan-header {
                padding: 20px 15px;
            }
            
            .plan-title {
                font-size: 20px;
            }
        }

        /* Professional loading states */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }

        /* Video Modal Styles */
        .video-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            animation: fadeIn 0.3s ease;
        }

        .video-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .video-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .video-modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #1e3a8a;
            display: flex;
            align-items: center;
        }

        .video-close {
            background: #dc2626;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .video-close:hover {
            background: #b91c1c;
            transform: scale(1.05);
        }

        .video-player {
            width: 100%;
            max-width: 800px;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .video-placeholder {
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .video-placeholder i {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .video-modal-content {
                padding: 20px;
                margin: 20px;
            }
            
            .video-placeholder {
                height: 250px;
            }
            
            .video-placeholder i {
                font-size: 50px;
            }
        }

        /* Progress indicator for video upload */
        .upload-progress {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            width: 0%;
            transition: width 0.3s ease;
        }

        .video-upload-status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .video-upload-status.success {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #059669;
        }

        .video-upload-status.error {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #dc2626;
        }

        /* FC calculation info box */
        .fc-info-box {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-size: 13px;
            color: #0c4a6e;
        }

        .fc-calculated {
            background: #dcfce7;
            border: 1px solid #22c55e;
            color: #166534;
            font-weight: 600;
        }

        /* Main App Styles */
        .main-app {
            display: none;
        }

        .header {
            background: #1e3a8a;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-bottom: 4px solid #dc2626;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-icon {
            font-size: 32px;
            color: #dc2626;
        }

        .header-title {
            font-size: 28px;
            font-weight: bold;
            color: white;
            letter-spacing: 1px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            color: white;
            font-weight: 500;
        }

        .admin-badge {
            background: #dc2626;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .logout-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        .nav-bar {
            background: #1e40af;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 0;
        }

        .nav-btn {
            background: none;
            border: none;
            color: white;
            padding: 20px 30px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: rgba(220, 38, 38, 0.1);
            color: #fca5a5;
        }

        .nav-btn.active {
            border-bottom-color: #dc2626;
            background: rgba(220, 38, 38, 0.1);
            color: #fca5a5;
        }

        .content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
            border-left: 5px solid #dc2626;
        }

        .card-title {
            font-size: 24px;
            font-weight: bold;
            color: #1e3a8a;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-field {
            margin-bottom: 20px;
        }

        .field-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .field-input, .field-select, .field-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .field-input:focus, .field-select:focus, .field-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 5px solid #dc2626;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .stat-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stat-icon {
            font-size: 40px;
            padding: 15px;
            border-radius: 12px;
            color: white;
        }

        .stat-icon.clients { background: #3b82f6; }
        .stat-icon.tests { background: #10b981; }
        .stat-icon.workouts { background: #8b5cf6; }

        .stat-info h3 {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .stat-info p {
            font-size: 32px;
            font-weight: bold;
            color: #1f2937;
        }

        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-cols-1 { grid-template-columns: 1fr; }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }

        @media (max-width: 768px) {
            .grid-cols-2, .grid-cols-3 {
                grid-template-columns: 1fr;
            }
        }

        .client-card, .test-card, .exercise-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .client-card:hover, .test-card:hover, .exercise-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .exercise-card {
            border-left: 5px solid #dc2626;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }

        .exercise-number {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #3b82f6;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .exercise-title {
            font-size: 20px;
            font-weight: bold;
            color: #1e3a8a;
            margin-bottom: 15px;
            padding-right: 40px;
        }

        .exercise-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .detail-label {
            font-weight: 600;
            color: #dc2626;
        }

        .heart-rate {
            background: #fef2f2;
            border: 1px solid #fca5a5;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .heart-icon {
            color: #dc2626;
            font-size: 18px;
        }

        .notes-section {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .notes-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .workout-plan {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .plan-title {
            font-size: 22px;
            font-weight: bold;
            color: #1e3a8a;
        }

        .plan-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .video-indicator {
            background: #dbeafe;
            color: #1e40af;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }

        .text-center { text-align: center; }
        .text-gray { color: #6b7280; }
        .py-8 { padding: 2rem 0; }

        /* RM Badge Styling */
        .rm-badge {
            background: #8b5cf6;
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        .rm-section {
            background: #f3e8ff;
            border: 1px solid #c4b5fd;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rm-icon {
            color: #8b5cf6;
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .nav-content {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-btn {
                padding: 15px 20px;
                font-size: 14px;
            }
            
            .plan-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .plan-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Sync Indicator -->
    <div id="syncIndicator" class="sync-indicator">
        <i class="fas fa-check-circle sync-icon"></i>
        <span>Dati sincronizzati con successo!</span>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="logo-section">
                <i class="fas fa-dumbbell logo-icon"></i>
                <h1 class="app-title">NUTRICIT FITNESS</h1>
                <p class="app-subtitle">Sistema di Gestione Allenamenti Ibrido</p>
            </div>

            <div id="loginAlert" class="alert alert-error hidden">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Credenziali non valide. Riprova.</span>
            </div>

            <div class="form-group">
                <label class="form-label">Username</label>
                <div style="position: relative;">
                    <i class="fas fa-user input-icon"></i>
                    <input type="text" id="username" class="form-input" placeholder="Inserisci il tuo username">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <div style="position: relative;">
                    <i class="fas fa-lock input-icon"></i>
                    <input type="password" id="password" class="form-input" placeholder="Inserisci la tua password">
                </div>
            </div>

            <button id="loginBtn" class="login-btn">
                <i class="fas fa-sign-in-alt"></i>
                Accedi al Sistema
            </button>

            <div class="credentials-info">
                <div class="credentials-title">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 8px;"></i>
                    Informazioni per i clienti
                </div>
                <div class="credentials-list">
                    <strong>Username:</strong> nome.cognome (tutto minuscolo)<br>
                    <strong>Password:</strong> Fornita dal tuo personal trainer<br>
                    <em>Se non hai le credenziali, contatta il tuo trainer</em>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Modal -->
    <div id="videoModal" class="video-modal">
        <div class="video-modal-content">
            <div class="video-modal-header">
                <h3 class="video-modal-title">
                    <i class="fas fa-play-circle" style="margin-right: 10px; color: #dc2626;"></i>
                    <span id="videoTitle">Video Esercizio</span>
                </h3>
                <button class="video-close" onclick="closeVideoModal()">
                    <i class="fas fa-times"></i>
                    Chiudi
                </button>
            </div>
            <div id="videoContainer">
                <!-- Il video verrà inserito qui dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <i class="fas fa-dumbbell header-icon"></i>
                    <h1 class="header-title">NUTRICIT FITNESS</h1>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        Ciao, <span id="currentUserName"></span>
                        <span id="adminBadge" class="admin-badge hidden">(Admin)</span>
                    </div>
                    <button id="logoutBtn" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-bar">
            <div class="nav-content">
                <button class="nav-btn active" onclick="showTab('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </button>
                <button class="nav-btn hidden" id="clientsTab" onclick="showTab('clients')">
                    <i class="fas fa-users"></i>
                    Clienti
                </button>
                <button class="nav-btn hidden" id="testsTab" onclick="showTab('tests')">
                    <i class="fas fa-file-text"></i>
                    Test
                </button>
                <button class="nav-btn" onclick="showTab('workouts')">
                    <i class="fas fa-dumbbell"></i>
                    Piani Allenamento
                </button>
                <button class="nav-btn" id="clientTestsTab" onclick="showTab('mytests')" style="display: none;">
                    <i class="fas fa-clipboard-check"></i>
                    I Miei Test
                </button>
            </div>
        </nav>

        <!-- Content Area -->
        <div class="content">
            <!-- Dashboard -->
            <div id="dashboardContent" class="tab-content">
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-icon clients">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3>Clienti Totali</h3>
                                <p id="totalClients">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-icon tests">
                                <i class="fas fa-file-text"></i>
                            </div>
                            <div class="stat-info">
                                <h3>Test Disponibili</h3>
                                <p id="totalTests">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-icon workouts">
                                <i class="fas fa-dumbbell"></i>
                            </div>
                            <div class="stat-info">
                                <h3>Piani Allenamento</h3>
                                <p id="totalWorkouts">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-chart-line"></i>
                        Panoramica Sistema
                    </h2>
                    <div id="dashboardWelcomeText">
                        <p>Benvenuto nel sistema di gestione allenamenti NUTRICIT FITNESS. Utilizza la navigazione sopra per accedere alle diverse sezioni del sistema.</p>
                    </div>
                </div>
            </div>

            <!-- Clients Tab -->
            <div id="clientsContent" class="tab-content hidden">
                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-user-plus"></i>
                        <span id="clientFormTitle">Aggiungi Nuovo Cliente</span>
                    </h2>
                    
                    <div class="form-grid">
                        <div class="form-field">
                            <label class="field-label">Nome *</label>
                            <input type="text" id="clientNome" class="field-input" placeholder="Nome">
                        </div>
                        <div class="form-field">
                            <label class="field-label">Cognome *</label>
                            <input type="text" id="clientCognome" class="field-input" placeholder="Cognome">
                        </div>
                        <div class="form-field">
                            <label class="field-label">Residenza</label>
                            <input type="text" id="clientResidenza" class="field-input" placeholder="Residenza">
                        </div>
                        <div class="form-field">
                            <label class="field-label">Età *</label>
                            <input type="number" id="clientEta" class="field-input" placeholder="Età" onchange="calculateFCMax()">
                        </div>
                        <div class="form-field">
                            <label class="field-label">Giorni Allenamento</label>
                            <input type="text" id="clientGiorni" class="field-input" placeholder="Es: Lun, Mer, Ven">
                        </div>
                        <div class="form-field">
                            <label class="field-label">Obiettivo</label>
                            <input type="text" id="clientObiettivo" class="field-input" placeholder="Obiettivo">
                        </div>
                        <div class="form-field">
                            <label class="field-label">FC Riposo (bpm) *</label>
                            <input type="number" id="clientFcRiposo" class="field-input" placeholder="FC a riposo" onchange="calculateFCMax()">
                        </div>
                        <div class="form-field">
                            <label class="field-label">Metodo Calcolo FC *</label>
                            <select id="clientMetodoFC" class="field-select" onchange="calculateFCMax()">
                                <option value="">Seleziona metodo</option>
                                <option value="COOPER">COOPER</option>
                                <option value="TANAKA">TANAKA</option>
                                <option value="KARVONEN">KARVONEN</option>
                                <option value="GELLISH">GELLISH</option>
                            </select>
                        </div>
                        <div class="form-field" id="intensitaField" style="display: none;">
                            <label class="field-label">Intensità (solo per KARVONEN)</label>
                            <select id="clientIntensita" class="field-select" onchange="calculateFCMax()">
                                <option value="10">10%</option>
                                <option value="20">20%</option>
                                <option value="30">30%</option>
                                <option value="40">40%</option>
                                <option value="50">50%</option>
                                <option value="60">60%</option>
                                <option value="70" selected>70%</option>
                                <option value="80">80%</option>
                                <option value="90">90%</option>
                                <option value="100">100%</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label class="field-label">FC Max (bpm) - CALCOLATA AUTOMATICAMENTE</label>
                            <input type="number" id="clientFcMax" class="field-input" placeholder="FC Massimale" readonly style="background: #f3f4f6; cursor: not-allowed;">
                            <div id="fcCalculationInfo" class="fc-info-box" style="display: none;">
                                <i class="fas fa-calculator" style="margin-right: 5px;"></i>
                                <span id="fcCalculationText"></span>
                            </div>
                        </div>
                        <div class="form-field">
                            <label class="field-label">Patologie/Farmaci</label>
                            <textarea id="clientPatologie" class="field-textarea" rows="3" placeholder="Patologie o farmaci"></textarea>
                        </div>
                        <div class="form-field">
                            <label class="field-label">Password *</label>
                            <input type="password" id="clientPassword" class="field-input" placeholder="Password per accesso">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button id="saveClientBtn" class="btn btn-primary" onclick="saveClient()">
                            <i class="fas fa-save"></i>
                            Salva Cliente
                        </button>
                        <button id="cancelClientBtn" class="btn btn-secondary hidden" onclick="cancelClientEdit()">
                            <i class="fas fa-times"></i>
                            Annulla
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-users"></i>
                        Lista Clienti
                    </h2>
                    <div id="clientsList" class="grid grid-cols-1"></div>
                </div>
            </div>

            <!-- Tests Tab -->
            <div id="testsContent" class="tab-content hidden">
                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-plus-circle"></i>
                        <span id="testFormTitle">Aggiungi Nuovo Test</span>
                    </h2>
                    
                    <div class="form-grid">
                        <div class="form-field">
                            <label class="field-label">Nome Test *</label>
                            <input type="text" id="testNome" class="field-input" placeholder="Nome del test">
                        </div>
                        <div class="form-field">
                            <label class="field-label">Esito</label>
                            <select id="testEsito" class="field-select" onchange="toggleEserciziAdattareSection()">
                                <option value="negativo">Negativo</option>
                                <option value="positivo">Positivo</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label class="field-label">Assegna a Cliente</label>
                            <select id="testClientAssignment" class="field-select">
                                <option value="">Nessun cliente specifico</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="eserciziAdattareSection" class="form-field hidden">
                        <label class="field-label">Esercizi da Adattare</label>
                        <textarea id="testEserciziAdattare" class="field-textarea" rows="4" placeholder="Descrizione degli esercizi da adattare..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button id="saveTestBtn" class="btn btn-primary" onclick="saveTest()">
                            <i class="fas fa-save"></i>
                            Salva Test
                        </button>
                        <button id="cancelTestBtn" class="btn btn-secondary hidden" onclick="cancelTestEdit()">
                            <i class="fas fa-times"></i>
                            Annulla
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-list"></i>
                        Lista Test
                    </h2>
                    <div id="testsList" class="grid grid-cols-1"></div>
                </div>
            </div>

            <!-- My Tests Tab (Client Only) -->
            <div id="mytestsContent" class="tab-content hidden">
                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-clipboard-check"></i>
                        I Miei Test di Valutazione
                    </h2>
                    <div id="clientTestsList"></div>
                </div>
            </div>

            <!-- Workouts Tab -->
            <div id="workoutsContent" class="tab-content hidden">
                <div id="adminWorkoutForm" class="card hidden">
                    <h2 class="card-title">
                        <i class="fas fa-plus"></i>
                        Crea Piano Allenamento
                    </h2>
                    
                    <div class="form-grid">
                        <div class="form-field">
                            <label class="field-label">Seleziona Cliente</label>
                            <select id="selectedClient" class="field-select" onchange="onClientSelected()">
                                <option value="">Seleziona un cliente</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label class="field-label">Data Inizio Piano</label>
                            <input type="date" id="workoutStartDate" class="field-input">
                        </div>
                        <div class="form-field">
                            <label class="field-label">Data Fine Piano</label>
                            <input type="date" id="workoutEndDate" class="field-input">
                        </div>
                    </div>
                    
                    <div id="exerciseFormSection" class="hidden" style="margin-top: 30px;">
                        <h3 style="margin-bottom: 20px; color: #1e3a8a;">
                            <i class="fas fa-dumbbell"></i>
                            Aggiungi Esercizio
                        </h3>
                        
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">Giorno Allenamento *</label>
                                <select id="exerciseDay" class="field-select">
                                    <option value="Lunedì">Lunedì</option>
                                    <option value="Martedì">Martedì</option>
                                    <option value="Mercoledì">Mercoledì</option>
                                    <option value="Giovedì">Giovedì</option>
                                    <option value="Venerdì">Venerdì</option>
                                    <option value="Sabato">Sabato</option>
                                    <option value="Domenica">Domenica</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label class="field-label">Nome Esercizio *</label>
                                <input type="text" id="exerciseNome" class="field-input" placeholder="Nome esercizio">
                            </div>
                            <div class="form-field">
                                <label class="field-label">Serie *</label>
                                <input type="number" id="exerciseSerie" class="field-input" placeholder="Numero serie">
                            </div>
                            <div class="form-field">
                                <label class="field-label">Ripetizioni *</label>
                                <input type="number" id="exerciseRipetizioni" class="field-input" placeholder="Numero ripetizioni">
                            </div>
                            <div class="form-field">
                                <label class="field-label">Riposo (secondi) *</label>
                                <input type="number" id="exerciseRiposo" class="field-input" placeholder="Secondi di riposo">
                            </div>
                            <div class="form-field">
                                <label class="field-label">Tipologia Allenamento *</label>
                                <select id="exerciseTipologia" class="field-select">
                                    <option value="">Seleziona tipologia</option>
                                    <option value="FORZA">FORZA</option>
                                    <option value="CARDIOVASCOLARE">CARDIOVASCOLARE</option>
                                    <option value="FUNZIONALE">FUNZIONALE</option>
                                    <option value="RIABILITATIVO">RIABILITATIVO</option>
                                    <option value="STRUTTURALE">STRUTTURALE</option>
                                    <option value="PROPRIOCEZIONE">PROPRIOCEZIONE</option>
                                    <option value="CORESTABILITY">CORESTABILITY</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label class="field-label">Frequenza Cardiaca</label>
                                <select id="exerciseFC" class="field-select">
                                    <option value="10">10% FC Max</option>
                                    <option value="20">20% FC Max</option>
                                    <option value="30">30% FC Max</option>
                                    <option value="40">40% FC Max</option>
                                    <option value="50">50% FC Max</option>
                                    <option value="60">60% FC Max</option>
                                    <option value="70" selected>70% FC Max</option>
                                    <option value="80">80% FC Max</option>
                                    <option value="90">90% FC Max</option>
                                    <option value="100">100% FC Max</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label class="field-label">% RM (Ripetizione Massimale) *</label>
                                <select id="exerciseRM" class="field-select">
                                    <option value="10">10% RM</option>
                                    <option value="20">20% RM</option>
                                    <option value="30">30% RM</option>
                                    <option value="40">40% RM</option>
                                    <option value="50">50% RM</option>
                                    <option value="60">60% RM</option>
                                    <option value="70" selected>70% RM</option>
                                    <option value="80">80% RM</option>
                                    <option value="90">90% RM</option>
                                    <option value="100">100% RM</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-field">
                            <label class="field-label">Note per il cliente</label>
                            <textarea id="exerciseNote" class="field-textarea" rows="3" placeholder="Note aggiuntive per il cliente..."></textarea>
                        </div>
                        
                        <div class="form-field">
                            <label class="field-label">Video Esercizio</label>
                            <input type="file" id="exerciseVideo" class="field-input" accept="video/*" onchange="handleVideoUpload(this)">
                            <div id="videoUploadStatus" class="video-upload-status">
                                <i class="fas fa-info-circle"></i>
                                <span id="videoUploadText">Seleziona un video (max 100MB)</span>
                            </div>
                            <div id="videoUploadProgress" class="upload-progress" style="display: none;">
                                <div id="videoUploadProgressBar" class="upload-progress-bar"></div>
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="addExercise()">
                            <i class="fas fa-plus"></i>
                            Aggiungi Esercizio
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-list-alt"></i>
                        Piani Allenamento
                    </h2>
                    <div id="workoutPlansList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let editingClientId = null;
        let editingTestId = null;
        let currentVideoData = null; // Memorizza i dati video temporaneamente

        // Initialize app when page loads
        window.onload = function() {
            console.log('App inizializzata');
            initializeData();
            setupEventListeners();
        };

        // Setup event listeners
        function setupEventListeners() {
            // Login button
            document.getElementById('loginBtn').onclick = function() {
                login();
            };
            
            // Enter key on login fields
            document.getElementById('username').onkeypress = function(e) {
                if (e.key === 'Enter') login();
            };
            document.getElementById('password').onkeypress = function(e) {
                if (e.key === 'Enter') login();
            };
            
            // Logout button
            document.getElementById('logoutBtn').onclick = function() {
                logout();
            };
        }

        // FC MAX CALCULATION FUNCTION
        function calculateFCMax() {
            const eta = parseInt(document.getElementById('clientEta').value);
            const fcRiposo = parseInt(document.getElementById('clientFcRiposo').value);
            const metodo = document.getElementById('clientMetodoFC').value;
            const intensita = parseInt(document.getElementById('clientIntensita').value);
            
            const fcMaxField = document.getElementById('clientFcMax');
            const infoBox = document.getElementById('fcCalculationInfo');
            const infoText = document.getElementById('fcCalculationText');
            const intensitaField = document.getElementById('intensitaField');
            
            // Show/hide intensity field based on method
            if (metodo === 'KARVONEN') {
                intensitaField.style.display = 'block';
            } else {
                intensitaField.style.display = 'none';
            }
            
            if (!eta || !metodo) {
                fcMaxField.value = '';
                infoBox.style.display = 'none';
                return;
            }
            
            let fcMax = 0;
            let formula = '';
            
            switch (metodo) {
                case 'COOPER':
                    fcMax = 220 - eta;
                    formula = `COOPER: 220 - ${eta} = ${fcMax} bpm`;
                    break;
                    
                case 'TANAKA':
                    fcMax = Math.round(208 - (0.7 * eta));
                    formula = `TANAKA: 208 - (0.7 × ${eta}) = ${fcMax} bpm`;
                    break;
                    
                case 'KARVONEN':
                    if (!fcRiposo || !intensita) {
                        fcMaxField.value = '';
                        infoBox.style.display = 'none';
                        return;
                    }
                    const fcReserva = Math.round(208 - (0.7 * eta)) - fcRiposo;
                    fcMax = Math.round(fcReserva * (intensita / 100) + fcRiposo);
                    formula = `KARVONEN: [(208 - (0.7 × ${eta})) - ${fcRiposo}] × ${intensita}% + ${fcRiposo} = ${fcMax} bpm`;
                    break;
                    
                case 'GELLISH':
                    fcMax = Math.round(207 - (0.7 * eta));
                    formula = `GELLISH: 207 - (0.7 × ${eta}) = ${fcMax} bpm`;
                    break;
            }
            
            if (fcMax > 0) {
                fcMaxField.value = fcMax;
                infoText.textContent = formula;
                infoBox.style.display = 'block';
                infoBox.className = 'fc-info-box fc-calculated';
            } else {
                fcMaxField.value = '';
                infoBox.style.display = 'none';
            }
        }

        // Video upload handling
        function handleVideoUpload(input) {
            const file = input.files[0];
            const statusDiv = document.getElementById('videoUploadStatus');
            const statusText = document.getElementById('videoUploadText');
            const progressDiv = document.getElementById('videoUploadProgress');
            const progressBar = document.getElementById('videoUploadProgressBar');
            
            if (!file) {
                currentVideoData = null;
                statusDiv.className = 'video-upload-status';
                statusDiv.style.display = 'none';
                return;
            }
            
            // Verifica dimensione file (max 100MB)
            const maxSize = 100 * 1024 * 1024; // 100MB in bytes
            if (file.size > maxSize) {
                statusDiv.className = 'video-upload-status error';
                statusDiv.style.display = 'block';
                statusText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> File troppo grande! Massimo 100MB.';
                input.value = '';
                currentVideoData = null;
                return;
            }
            
            // Verifica tipo file
            if (!file.type.startsWith('video/')) {
                statusDiv.className = 'video-upload-status error';
                statusDiv.style.display = 'block';
                statusText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Seleziona un file video valido.';
                input.value = '';
                currentVideoData = null;
                return;
            }
            
            // Mostra progress bar
            statusDiv.style.display = 'block';
            progressDiv.style.display = 'block';
            statusDiv.className = 'video-upload-status';
            statusText.innerHTML = '<i class="fas fa-upload"></i> Elaborazione video in corso...';
            
            // Simula upload progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(progressInterval);
                    
                    // Converti video in base64
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        currentVideoData = {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            data: e.target.result, // Data URL base64
                            lastModified: file.lastModified
                        };
                        
                        // Mostra successo
                        statusDiv.className = 'video-upload-status success';
                        statusText.innerHTML = `<i class="fas fa-check-circle"></i> Video caricato: ${file.name} (${(file.size / (1024 * 1024)).toFixed(1)} MB)`;
                        progressDiv.style.display = 'none';
                    };
                    
                    reader.onerror = function() {
                        statusDiv.className = 'video-upload-status error';
                        statusText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Errore nella lettura del file.';
                        progressDiv.style.display = 'none';
                        currentVideoData = null;
                    };
                    
                    reader.readAsDataURL(file);
                }
                progressBar.style.width = progress + '%';
            }, 100);
        }

        // Data management
        function saveData(key, data) {
            try {
                const dataString = JSON.stringify(data);
                // Verifica se i dati sono troppo grandi per localStorage
                if (dataString.length > 5000000) { // ~5MB limit
                    console.warn('Dati troppo grandi per localStorage, compressione in corso...');
                    // In una versione reale, qui potresti implementare compressione
                }
                localStorage.setItem('nutricit_' + key, dataString);
                showSyncIndicator();
                return true;
            } catch(e) {
                console.error('Errore salvataggio:', e);
                if (e.name === 'QuotaExceededError') {
                    alert('Spazio di archiviazione esaurito. Elimina alcuni video vecchi o contatta l\'amministratore.');
                }
                return false;
            }
        }

        function loadData(key) {
            try {
                const data = localStorage.getItem('nutricit_' + key);
                return data ? JSON.parse(data) : null;
            } catch(e) {
                console.error('Errore caricamento:', e);
                return null;
            }
        }

        function showSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            indicator.style.display = 'flex';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        function showSuccessMessage(message) {
            // Rimuovi eventuali messaggi esistenti
            const existing = document.querySelector('.success-indicator');
            if (existing) existing.remove();
            
            // Crea nuovo messaggio di successo
            const successDiv = document.createElement('div');
            successDiv.className = 'success-indicator';
            successDiv.innerHTML = `
                <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                ${message}
            `;
            
            document.body.appendChild(successDiv);
            
            // Rimuovi dopo 3 secondi
            setTimeout(() => {
                if (successDiv && successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 3000);
        }

        // Initialize data
        function initializeData() {
            let clients = loadData('clients');
            if (!clients || clients.length === 0) {
                clients = [{
                    id: 'admin',
                    username: 'marius.simiras',
                    password: 'Marius99!',
                    nome: 'Marius',
                    cognome: 'Simiras',
                    role: 'admin'
                }];
                saveData('clients', clients);
            } else {
                // Aggiorna le credenziali admin se necessario
                const adminIndex = clients.findIndex(c => c.role === 'admin');
                if (adminIndex !== -1) {
                    clients[adminIndex].username = 'marius.simiras';
                    clients[adminIndex].password = 'Marius99!';
                    saveData('clients', clients);
                }
            }

            let tests = loadData('tests');
            if (!tests) {
                saveData('tests', []);
            }

            let workouts = loadData('workouts');
            if (!workouts) {
                saveData('workouts', []);
            }
            
            console.log('Dati inizializzati:', clients);
        }

        // Authentication
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            console.log('Tentativo login:', username, password);
            
            if (!username || !password) {
                showLoginError('Inserisci username e password');
                return;
            }

            const clients = loadData('clients') || [];
            console.log('Clienti caricati:', clients);
            
            const user = clients.find(c => c.username === username && c.password === password);
            console.log('Utente trovato:', user);

            if (user) {
                currentUser = user;
                isAdmin = user.role === 'admin';
                
                hideLoginError();
                showMainApp();
                updateUserInterface();
            } else {
                showLoginError('Credenziali non valide');
            }
        }

        function logout() {
            currentUser = null;
            isAdmin = false;
            editingClientId = null;
            editingTestId = null;
            currentVideoData = null;
            showLoginScreen();
        }

        function showLoginError(message) {
            const alert = document.getElementById('loginAlert');
            alert.querySelector('span').textContent = message;
            alert.classList.remove('hidden');
        }

        function hideLoginError() {
            document.getElementById('loginAlert').classList.add('hidden');
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        // UI Management
        function updateUserInterface() {
            document.getElementById('currentUserName').textContent = currentUser.nome + ' ' + currentUser.cognome;
            
            if (isAdmin) {
                document.getElementById('adminBadge').classList.remove('hidden');
                document.getElementById('clientsTab').classList.remove('hidden');
                document.getElementById('testsTab').classList.remove('hidden');
                document.getElementById('adminWorkoutForm').classList.remove('hidden');
                document.getElementById('clientTestsTab').style.display = 'none';
                document.getElementById('dashboardWelcomeText').style.display = 'block';
            } else {
                document.getElementById('adminBadge').classList.add('hidden');
                document.getElementById('clientsTab').classList.add('hidden');
                document.getElementById('testsTab').classList.add('hidden');
                document.getElementById('adminWorkoutForm').classList.add('hidden');
                document.getElementById('clientTestsTab').style.display = 'flex';
                document.getElementById('dashboardWelcomeText').style.display = 'none';
            }
            
            updateDashboardStats();
            showTab('dashboard');
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'dashboard') {
                updateDashboardStats();
            } else if (tabName === 'clients') {
                loadClientsList();
            } else if (tabName === 'tests') {
                loadTestsList();
                loadClientsForTests();
            } else if (tabName === 'workouts') {
                loadWorkoutsList();
                loadClientsForWorkout();
            } else if (tabName === 'mytests') {
                loadClientTests();
            }
        }

        // Dashboard
        function updateDashboardStats() {
            const clients = loadData('clients') || [];
            const tests = loadData('tests') || [];
            const workouts = loadData('workouts') || [];
            
            document.getElementById('totalClients').textContent = clients.filter(c => c.role === 'client').length;
            document.getElementById('totalTests').textContent = tests.length;
            document.getElementById('totalWorkouts').textContent = workouts.length;
        }

        // Clients Management
        function saveClient() {
            const nome = document.getElementById('clientNome').value.trim();
            const cognome = document.getElementById('clientCognome').value.trim();
            const password = document.getElementById('clientPassword').value.trim();
            const eta = document.getElementById('clientEta').value.trim();
            const fcRiposo = document.getElementById('clientFcRiposo').value.trim();
            const metodo = document.getElementById('clientMetodoFC').value.trim();
            
            if (!nome || !cognome || !password || !eta || !fcRiposo || !metodo) {
                alert('Nome, cognome, età, FC riposo, metodo calcolo FC e password sono obbligatori');
                return;
            }
            
            const clients = loadData('clients') || [];
            const clientData = {
                nome: nome,
                cognome: cognome,
                residenza: document.getElementById('clientResidenza').value.trim(),
                eta: parseInt(eta),
                giorniAllenamento: document.getElementById('clientGiorni').value.trim(),
                obiettivo: document.getElementById('clientObiettivo').value.trim(),
                fcRiposo: parseInt(fcRiposo),
                fcMax: parseInt(document.getElementById('clientFcMax').value) || 0,
                metodCalcoloFC: metodo,
                intensita: document.getElementById('clientIntensita').value.trim(),
                patologie: document.getElementById('clientPatologie').value.trim(),
                password: password,
                username: nome.toLowerCase() + '.' + cognome.toLowerCase(),
                role: 'client'
            };
            
            if (editingClientId) {
                // Update existing client
                const index = clients.findIndex(c => c.id === editingClientId);
                if (index !== -1) {
                    clients[index] = { ...clients[index], ...clientData };
                }
                editingClientId = null;
                document.getElementById('clientFormTitle').textContent = 'Aggiungi Nuovo Cliente';
                document.getElementById('cancelClientBtn').classList.add('hidden');
            } else {
                // Add new client
                clientData.id = Date.now().toString();
                clients.push(clientData);
            }
            
            saveData('clients', clients);
            clearClientForm();
            loadClientsList();
            updateDashboardStats();
            
            if (editingClientId) {
                showSuccessMessage(`✅ Cliente ${clientData.nome} ${clientData.cognome} aggiornato con successo!`);
            } else {
                showSuccessMessage(`🎉 Cliente ${clientData.nome} ${clientData.cognome} aggiunto con successo!`);
            }
        }

        function editClient(clientId) {
            const clients = loadData('clients') || [];
            const client = clients.find(c => c.id === clientId);
            
            if (client) {
                editingClientId = clientId;
                document.getElementById('clientNome').value = client.nome || '';
                document.getElementById('clientCognome').value = client.cognome || '';
                document.getElementById('clientResidenza').value = client.residenza || '';
                document.getElementById('clientEta').value = client.eta || '';
                document.getElementById('clientGiorni').value = client.giorniAllenamento || '';
                document.getElementById('clientObiettivo').value = client.obiettivo || '';
                document.getElementById('clientFcRiposo').value = client.fcRiposo || '';
                document.getElementById('clientFcMax').value = client.fcMax || '';
                document.getElementById('clientMetodoFC').value = client.metodCalcoloFC || '';
                document.getElementById('clientIntensita').value = client.intensita || '70';
                document.getElementById('clientPatologie').value = client.patologie || '';
                document.getElementById('clientPassword').value = client.password || '';
                
                // Trigger FC calculation
                calculateFCMax();
                
                document.getElementById('clientFormTitle').textContent = 'Modifica Cliente';
                document.getElementById('cancelClientBtn').classList.remove('hidden');
            }
        }

        function deleteClient(clientId) {
            if (confirm('Sei sicuro di voler eliminare questo cliente?')) {
                let clients = loadData('clients') || [];
                clients = clients.filter(c => c.id !== clientId);
                saveData('clients', clients);
                
                // Remove associated workouts and tests
                let workouts = loadData('workouts') || [];
                workouts = workouts.filter(w => w.clientId !== clientId);
                saveData('workouts', workouts);
                
                let tests = loadData('tests') || [];
                tests = tests.filter(t => t.clientId !== clientId);
                saveData('tests', tests);
                
                loadClientsList();
                updateDashboardStats();
                showSuccessMessage('🗑️ Cliente eliminato con successo');
            }
        }

        function cancelClientEdit() {
            editingClientId = null;
            clearClientForm();
            document.getElementById('clientFormTitle').textContent = 'Aggiungi Nuovo Cliente';
            document.getElementById('cancelClientBtn').classList.add('hidden');
        }

        function clearClientForm() {
            document.getElementById('clientNome').value = '';
            document.getElementById('clientCognome').value = '';
            document.getElementById('clientResidenza').value = '';
            document.getElementById('clientEta').value = '';
            document.getElementById('clientGiorni').value = '';
            document.getElementById('clientObiettivo').value = '';
            document.getElementById('clientFcRiposo').value = '';
            document.getElementById('clientFcMax').value = '';
            document.getElementById('clientMetodoFC').value = '';
            document.getElementById('clientIntensita').value = '70';
            document.getElementById('clientPatologie').value = '';
            document.getElementById('clientPassword').value = '';
            document.getElementById('fcCalculationInfo').style.display = 'none';
            document.getElementById('intensitaField').style.display = 'none';
        }

        function loadClientsList() {
            const clients = loadData('clients') || [];
            const clientClients = clients.filter(c => c.role === 'client');
            const container = document.getElementById('clientsList');
            
            if (clientClients.length === 0) {
                container.innerHTML = '<p class="text-center text-gray py-8">Nessun cliente ancora registrato</p>';
                return;
            }
            
            container.innerHTML = clientClients.map(client => `
                <div class="client-card">
                    <h3 style="font-size: 20px; font-weight: bold; color: #1e3a8a; margin-bottom: 15px;">
                        ${client.nome} ${client.cognome}
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <p><strong>Età:</strong> ${client.eta || 'N/A'} anni</p>
                        <p><strong>Obiettivo:</strong> ${client.obiettivo || 'N/A'}</p>
                        <p><strong>FC Riposo:</strong> ${client.fcRiposo || 'N/A'} bpm</p>
                        <p><strong>FC Max:</strong> ${client.fcMax || 'N/A'} bpm</p>
                        <p><strong>Metodo FC:</strong> ${client.metodCalcoloFC || 'N/A'}</p>
                        <p><strong>Username:</strong> ${client.username}</p>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-warning" onclick="editClient('${client.id}')">
                            <i class="fas fa-edit"></i>
                            Modifica
                        </button>
                        <button class="btn btn-danger" onclick="deleteClient('${client.id}')">
                            <i class="fas fa-trash"></i>
                            Elimina
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Tests Management
        function loadClientsForTests() {
            const clients = loadData('clients') || [];
            const clientClients = clients.filter(c => c.role === 'client');
            const select = document.getElementById('testClientAssignment');
            
            select.innerHTML = '<option value="">Nessun cliente specifico</option>' +
                clientClients.map(client => `
                    <option value="${client.id}">${client.nome} ${client.cognome}</option>
                `).join('');
        }

        function saveTest() {
            const nome = document.getElementById('testNome').value.trim();
            
            if (!nome) {
                alert('Nome test obbligatorio');
                return;
            }
            
            const tests = loadData('tests') || [];
            const testData = {
                nome: nome,
                esito: document.getElementById('testEsito').value,
                eserciziAdattare: document.getElementById('testEserciziAdattare').value.trim(),
                clientId: document.getElementById('testClientAssignment').value || null
            };
            
            if (editingTestId) {
                // Update existing test
                const index = tests.findIndex(t => t.id === editingTestId);
                if (index !== -1) {
                    tests[index] = { ...tests[index], ...testData };
                }
                editingTestId = null;
                document.getElementById('testFormTitle').textContent = 'Aggiungi Nuovo Test';
                document.getElementById('cancelTestBtn').classList.add('hidden');
            } else {
                // Add new test
                testData.id = Date.now().toString();
                tests.push(testData);
            }
            
            saveData('tests', tests);
            clearTestForm();
            loadTestsList();
            updateDashboardStats();
            
            if (editingTestId) {
                showSuccessMessage(`✅ Test "${testData.nome}" aggiornato con successo!`);
            } else {
                showSuccessMessage(`🔬 Test "${testData.nome}" creato con successo!`);
            }
        }

        function editTest(testId) {
            const tests = loadData('tests') || [];
            const test = tests.find(t => t.id === testId);
            
            if (test) {
                editingTestId = testId;
                document.getElementById('testNome').value = test.nome || '';
                document.getElementById('testEsito').value = test.esito || 'negativo';
                document.getElementById('testEserciziAdattare').value = test.eserciziAdattare || '';
                document.getElementById('testClientAssignment').value = test.clientId || '';
                
                toggleEserciziAdattareSection();
                
                document.getElementById('testFormTitle').textContent = 'Modifica Test';
                document.getElementById('cancelTestBtn').classList.remove('hidden');
            }
        }

        function deleteTest(testId) {
            if (confirm('Sei sicuro di voler eliminare questo test?')) {
                let tests = loadData('tests') || [];
                tests = tests.filter(t => t.id !== testId);
                saveData('tests', tests);
                
                loadTestsList();
                updateDashboardStats();
                showSuccessMessage('🗑️ Test eliminato con successo');
            }
        }

        function cancelTestEdit() {
            editingTestId = null;
            clearTestForm();
            document.getElementById('testFormTitle').textContent = 'Aggiungi Nuovo Test';
            document.getElementById('cancelTestBtn').classList.add('hidden');
        }

        function clearTestForm() {
            document.getElementById('testNome').value = '';
            document.getElementById('testEsito').value = 'negativo';
            document.getElementById('testEserciziAdattare').value = '';
            document.getElementById('testClientAssignment').value = '';
            toggleEserciziAdattareSection();
        }

        function toggleEserciziAdattareSection() {
            const esito = document.getElementById('testEsito').value;
            const section = document.getElementById('eserciziAdattareSection');
            
            if (esito === 'positivo') {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        }

        function loadTestsList() {
            const tests = loadData('tests') || [];
            const clients = loadData('clients') || [];
            const container = document.getElementById('testsList');
            
            if (tests.length === 0) {
                container.innerHTML = '<p class="text-center text-gray py-8">Nessun test ancora creato</p>';
                return;
            }
            
            container.innerHTML = tests.map(test => {
                const assignedClient = test.clientId ? clients.find(c => c.id === test.clientId) : null;
                
                return `
                <div class="test-card">
                    <h3 style="font-size: 20px; font-weight: bold; color: #1e3a8a; margin-bottom: 15px;">
                        ${test.nome}
                    </h3>
                    <p style="margin-bottom: 10px;">
                        <strong>Esito:</strong> 
                        <span style="color: ${test.esito === 'positivo' ? '#dc2626' : '#059669'}; font-weight: 600;">
                            ${test.esito}
                        </span>
                    </p>
                    ${assignedClient ? `
                        <p style="margin-bottom: 10px;">
                            <strong>Assegnato a:</strong> 
                            <span style="color: #3b82f6; font-weight: 600;">
                                ${assignedClient.nome} ${assignedClient.cognome}
                            </span>
                        </p>
                    ` : `
                        <p style="margin-bottom: 10px;">
                            <strong>Assegnazione:</strong> 
                            <span style="color: #6b7280;">Test generale</span>
                        </p>
                    `}
                    ${test.esito === 'positivo' && test.eserciziAdattare ? `
                        <div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong style="color: #dc2626;">Esercizi da adattare:</strong><br>
                            ${test.eserciziAdattare}
                        </div>
                    ` : ''}
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-warning" onclick="editTest('${test.id}')">
                            <i class="fas fa-edit"></i>
                            Modifica
                        </button>
                        <button class="btn btn-danger" onclick="deleteTest('${test.id}')">
                            <i class="fas fa-trash"></i>
                            Elimina
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Client Tests View
        function loadClientTests() {
            const tests = loadData('tests') || [];
            const clientSpecificTests = tests.filter(t => t.clientId === currentUser.id);
            const generalTests = tests.filter(t => !t.clientId || t.clientId === '');
            const container = document.getElementById('clientTestsList');
            
            if (clientSpecificTests.length === 0 && generalTests.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-clipboard-check" style="font-size: 64px; color: #d1d5db; margin-bottom: 20px;"></i>
                        <h3 style="color: #6b7280; margin-bottom: 10px;">Nessun test disponibile</h3>
                        <p style="color: #9ca3af;">Il tuo trainer non ha ancora creato test.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Test specifici per il cliente
            if (clientSpecificTests.length > 0) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #1e3a8a; font-size: 20px; font-weight: bold; margin-bottom: 20px; display: flex; align-items: center;">
                            <i class="fas fa-user-check" style="margin-right: 10px; color: #dc2626;"></i>
                            I Tuoi Test Personalizzati
                        </h3>
                        ${clientSpecificTests.map(test => renderTestCard(test, true)).join('')}
                    </div>
                `;
            }
            
            // Test generali
            if (generalTests.length > 0) {
                html += `
                    <div>
                        <h3 style="color: #1e3a8a; font-size: 20px; font-weight: bold; margin-bottom: 20px; display: flex; align-items: center;">
                            <i class="fas fa-users" style="margin-right: 10px; color: #3b82f6;"></i>
                            Test di Valutazione Generale
                        </h3>
                        ${generalTests.map(test => renderTestCard(test, false)).join('')}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function renderTestCard(test, isPersonalized) {
            return `
                <div class="test-card" style="border-left: 5px solid ${test.esito === 'positivo' ? '#dc2626' : '#10b981'}; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <h4 style="font-size: 22px; font-weight: bold; color: #1e3a8a; margin-bottom: 10px;">
                            <i class="fas fa-clipboard-check" style="margin-right: 10px; color: #3b82f6;"></i>
                            ${test.nome}
                            ${isPersonalized ? '<span style="background: #dc2626; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; margin-left: 10px;">PERSONALIZZATO</span>' : ''}
                        </h4>
                        <span style="background: ${test.esito === 'positivo' ? '#fee2e2' : '#dcfce7'}; 
                                     color: ${test.esito === 'positivo' ? '#dc2626' : '#059669'}; 
                                     padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 12px;">
                            ${test.esito === 'positivo' ? '⚠️ DA MIGLIORARE' : '✅ SUPERATO'}
                        </span>
                    </div>
                    
                    <div style="background: ${test.esito === 'positivo' ? '#fffbeb' : '#f0fdf4'}; 
                                border: 1px solid ${test.esito === 'positivo' ? '#fed7aa' : '#bbf7d0'}; 
                                border-radius: 8px; padding: 15px; margin: 15px 0;">
                        ${test.esito === 'positivo' ? `
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <i class="fas fa-exclamation-triangle" style="color: #f59e0b; margin-right: 8px;"></i>
                                <strong style="color: #92400e;">Aree di Miglioramento</strong>
                            </div>
                            <p style="color: #78350f; line-height: 1.6;">
                                ${test.eserciziAdattare || 'Il trainer ti fornirà indicazioni specifiche per migliorare in questo test.'}
                            </p>
                        ` : `
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <i class="fas fa-check-circle" style="color: #10b981; margin-right: 8px;"></i>
                                <strong style="color: #065f46;">Test Superato!</strong>
                            </div>
                            <p style="color: #047857; line-height: 1.6;">
                                Complimenti! Hai superato questo test. Continua così per mantenere i tuoi progressi.
                            </p>
                        `}
                    </div>
                    
                    <div style="background: #f8fafc; border-radius: 8px; padding: 12px; margin-top: 15px;">
                        <small style="color: #64748b;">
                            <i class="fas fa-user" style="margin-right: 5px;"></i>
                            ${isPersonalized ? 'Test specifico assegnato dal tuo personal trainer' : 'Test generale di valutazione'} - Marius Simiras
                        </small>
                    </div>
                </div>
            `;
        }

        // Workout Management
        function loadClientsForWorkout() {
            const clients = loadData('clients') || [];
            const clientClients = clients.filter(c => c.role === 'client');
            const select = document.getElementById('selectedClient');
            
            select.innerHTML = '<option value="">Seleziona un cliente</option>' +
                clientClients.map(client => `
                    <option value="${client.id}">${client.nome} ${client.cognome}</option>
                `).join('');
        }

        function onClientSelected() {
            const selectedClientId = document.getElementById('selectedClient').value;
            const section = document.getElementById('exerciseFormSection');
            
            if (selectedClientId) {
                section.classList.remove('hidden');
                // Set default dates
                const today = new Date();
                const oneMonthLater = new Date(today);
                oneMonthLater.setMonth(today.getMonth() + 1);
                
                document.getElementById('workoutStartDate').value = today.toISOString().split('T')[0];
                document.getElementById('workoutEndDate').value = oneMonthLater.toISOString().split('T')[0];
            } else {
                section.classList.add('hidden');
            }
        }

        function addExercise() {
            const selectedClientId = document.getElementById('selectedClient').value;
            const startDate = document.getElementById('workoutStartDate').value;
            const endDate = document.getElementById('workoutEndDate').value;
            
            if (!selectedClientId || !startDate || !endDate) {
                alert('Seleziona cliente e inserisci date del piano');
                return;
            }
            
            if (new Date(startDate) >= new Date(endDate)) {
                alert('La data di fine deve essere successiva alla data di inizio');
                return;
            }
            
            const day = document.getElementById('exerciseDay').value;
            const nome = document.getElementById('exerciseNome').value.trim();
            const serie = document.getElementById('exerciseSerie').value.trim();
            const ripetizioni = document.getElementById('exerciseRipetizioni').value.trim();
            const riposo = document.getElementById('exerciseRiposo').value.trim();
            const tipologia = document.getElementById('exerciseTipologia').value;
            
            if (!day || !nome || !serie || !ripetizioni || !riposo || !tipologia) {
                alert('Compila tutti i campi obbligatori');
                return;
            }
            
            const workouts = loadData('workouts') || [];
            const planKey = `${selectedClientId}-${startDate}-${endDate}`;
            let existingPlan = workouts.find(w => w.planKey === planKey);
            
            const exercise = {
                id: Date.now().toString(),
                day: day,
                nome: nome,
                serie: parseInt(serie),
                ripetizioni: parseInt(ripetizioni),
                riposo: parseInt(riposo),
                tipologia: tipologia,
                frequenzaCardiaca: parseInt(document.getElementById('exerciseFC').value),
                percentualeRM: parseInt(document.getElementById('exerciseRM').value), // Nuovo campo RM
                note: document.getElementById('exerciseNote').value.trim(),
                videoData: currentVideoData // Salva i dati video completi
            };
            
            if (existingPlan) {
                existingPlan.exercises = existingPlan.exercises || [];
                existingPlan.exercises.push(exercise);
            } else {
                const newPlan = {
                    id: Date.now().toString(),
                    planKey: planKey,
                    clientId: selectedClientId,
                    startDate: startDate,
                    endDate: endDate,
                    exercises: [exercise]
                };
                workouts.push(newPlan);
            }
            
            if (saveData('workouts', workouts)) {
                clearExerciseForm();
                loadWorkoutsList();
                updateDashboardStats();
                
                showSuccessMessage(`💪 Esercizio "${exercise.nome}" aggiunto al ${day}!${currentVideoData ? ' Con video incluso!' : ''}`);
                currentVideoData = null; // Reset video data
            } else {
                alert('Errore nel salvataggio. Il video potrebbe essere troppo grande.');
            }
        }

        function clearExerciseForm() {
            document.getElementById('exerciseDay').value = 'Lunedì';
            document.getElementById('exerciseNome').value = '';
            document.getElementById('exerciseSerie').value = '';
            document.getElementById('exerciseRipetizioni').value = '';
            document.getElementById('exerciseRiposo').value = '';
            document.getElementById('exerciseTipologia').value = '';
            document.getElementById('exerciseFC').value = '70';
            document.getElementById('exerciseRM').value = '70'; // Reset RM field
            document.getElementById('exerciseNote').value = '';
            document.getElementById('exerciseVideo').value = '';
            
            // Reset video upload status
            const statusDiv = document.getElementById('videoUploadStatus');
            const statusText = document.getElementById('videoUploadText');
            statusDiv.style.display = 'none';
            statusText.innerHTML = 'Seleziona un video (max 100MB)';
            currentVideoData = null;
        }

        function deleteWorkoutPlan(planId) {
            if (confirm('Sei sicuro di voler eliminare questo piano di allenamento?')) {
                let workouts = loadData('workouts') || [];
                workouts = workouts.filter(w => w.id !== planId);
                saveData('workouts', workouts);
                
                loadWorkoutsList();
                updateDashboardStats();
                showSuccessMessage('🗑️ Piano di allenamento eliminato con successo');
            }
        }

        function downloadPDF(planId) {
            const workouts = loadData('workouts') || [];
            const clients = loadData('clients') || [];
            
            const plan = workouts.find(w => w.id === planId);
            const client = clients.find(c => c.id === plan.clientId);
            
            if (!plan || !client) {
                alert('Errore nel caricamento dei dati per il PDF');
                return;
            }
            
            try {
                if (typeof window.jspdf === 'undefined') {
                    alert('Errore: Libreria PDF non caricata. Ricarica la pagina e riprova.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // === INTESTAZIONE PROFESSIONALE ===
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.setTextColor(30, 58, 138);
                doc.text("PERSONAL FITNESS TRAINER", 105, 20, { align: 'center' });
                
                doc.setFontSize(16);
                doc.setTextColor(220, 38, 38);
                doc.text("MARIUS CONSTANTIN SIMIRAS", 105, 30, { align: 'center' });
                
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(1);
                doc.line(20, 35, 190, 35);
                
                doc.setFontSize(14);
                doc.setTextColor(30, 58, 138);
                doc.text("SCHEDA ALLENAMENTO", 105, 45, { align: 'center' });
                
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.setTextColor(220, 38, 38);
                doc.text(`${client.nome.toUpperCase()} ${client.cognome.toUpperCase()}`, 105, 55, { align: 'center' });
                
                let yPos = 70;
                
                // === PERIODO ALLENAMENTO ===
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.setTextColor(30, 58, 138);
                doc.text("PERIODO ALLENAMENTO", 20, yPos);
                
                doc.setFillColor(248, 250, 252);
                doc.roundedRect(20, yPos + 5, 170, 15, 3, 3, 'F');
                
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Inizio: ${new Date(plan.startDate).toLocaleDateString('it-IT')}`, 25, yPos + 15);
                doc.text(`Fine: ${new Date(plan.endDate).toLocaleDateString('it-IT')}`, 110, yPos + 15);
                
                yPos += 30;
                
                // === DATI PERSONALI ===
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.setTextColor(30, 58, 138);
                doc.text("DATI PERSONALI", 20, yPos);
                
                doc.setFillColor(240, 249, 255);
                doc.roundedRect(20, yPos + 5, 170, 35, 3, 3, 'F');
                
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                doc.text(`Età: ${client.eta || 'N/A'} anni`, 25, yPos + 15);
                doc.text(`Obiettivo: ${client.obiettivo || 'N/A'}`, 110, yPos + 15);
                doc.text(`FC Riposo: ${client.fcRiposo || 'N/A'} bpm`, 25, yPos + 25);
                doc.text(`FC Max: ${client.fcMax || 'N/A'} bpm`, 110, yPos + 25);
                doc.text(`Metodo FC: ${client.metodCalcoloFC || 'N/A'}`, 25, yPos + 35);
                if (client.intensita && client.metodCalcoloFC === 'KARVONEN') {
                    doc.text(`Intensità: ${client.intensita}%`, 110, yPos + 35);
                }
                
                yPos += 50;
                
                // === NOTE MEDICHE ===
                if (client.patologie && client.patologie.trim()) {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(12);
                    doc.setTextColor(220, 38, 38);
                    doc.text("NOTE MEDICHE", 20, yPos);
                    
                    doc.setFillColor(254, 242, 242);
                    doc.setDrawColor(248, 113, 113);
                    doc.roundedRect(20, yPos + 5, 170, 20, 3, 3, 'FD');
                    
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(9);
                    doc.setTextColor(153, 27, 27);
                    const patologieLines = doc.splitTextToSize(client.patologie, 160);
                    doc.text(patologieLines, 25, yPos + 15);
                    
                    yPos += 30;
                }
                
                // === PIANO DI ALLENAMENTO ===
                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                doc.setTextColor(30, 58, 138);
                doc.text("PIANO DI ALLENAMENTO", 20, yPos);
                yPos += 15;
                
                if (plan.exercises && plan.exercises.length > 0) {
                    // Raggruppa esercizi per giorno
                    const exercisesByDay = {};
                    plan.exercises.forEach(exercise => {
                        if (!exercisesByDay[exercise.day]) {
                            exercisesByDay[exercise.day] = [];
                        }
                        exercisesByDay[exercise.day].push(exercise);
                    });
                    
                    const dayOrder = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];
                    
                    dayOrder.forEach(day => {
                        if (exercisesByDay[day]) {
                            // Controlla spazio per nuovo giorno
                            if (yPos > 230) {
                                doc.addPage();
                                yPos = 30;
                            }
                            
                            // Titolo giorno
                            doc.setFont("helvetica", "bold");
                            doc.setFontSize(12);
                            doc.setTextColor(220, 38, 38);
                            doc.text(`${day.toUpperCase()}`, 20, yPos);
                            
                            yPos += 8;
                            
                            // Box contenitore per il giorno
                            const totalExerciseHeight = exercisesByDay[day].length * 30; // Aumentato per includere RM
                            
                            doc.setFillColor(248, 250, 252);
                            doc.setDrawColor(59, 130, 246);
                            doc.roundedRect(20, yPos - 3, 170, totalExerciseHeight + 5, 3, 3, 'FD');
                            
                            // Esercizi del giorno
                            exercisesByDay[day].forEach((exercise, index) => {
                                const fcCalcolata = Math.round((exercise.frequenzaCardiaca / 100) * (client.fcMax || 0));
                                
                                // Nome esercizio
                                doc.setFont("helvetica", "bold");
                                doc.setFontSize(10);
                                doc.setTextColor(30, 58, 138);
                                doc.text(`${index + 1}. ${exercise.nome.toUpperCase()}`, 25, yPos + 5);
                                
                                // Dettagli esercizio
                                doc.setFont("helvetica", "normal");
                                doc.setFontSize(8);
                                doc.setTextColor(0, 0, 0);
                                
                                const details = `${exercise.tipologia} • ${exercise.serie} serie • ${exercise.ripetizioni} rip • ${exercise.riposo}s`;
                                doc.text(details, 25, yPos + 12);
                                
                                // Frequenza cardiaca
                                doc.setFont("helvetica", "bold");
                                doc.setTextColor(220, 38, 38);
                                doc.text(`FC: ${exercise.frequenzaCardiaca}% (${fcCalcolata} bpm)`, 25, yPos + 18);
                                
                                // % RM - NUOVO CAMPO
                                doc.setFont("helvetica", "bold");
                                doc.setTextColor(139, 92, 246);
                                doc.text(`RM: ${exercise.percentualeRM || 70}% del massimale`, 25, yPos + 24);
                                
                                // Indicatore video se presente
                                if (exercise.videoData) {
                                    doc.setFont("helvetica", "italic");
                                    doc.setFontSize(7);
                                    doc.setTextColor(59, 130, 246);
                                    doc.text("📱 Video dimostrativo disponibile nell'app", 25, yPos + 28);
                                }
                                
                                // Note se presenti
                                if (exercise.note) {
                                    doc.setFont("helvetica", "italic");
                                    doc.setFontSize(7);
                                    doc.setTextColor(75, 85, 99);
                                    const noteText = doc.splitTextToSize(exercise.note, 140);
                                    doc.text(noteText, 25, yPos + 29);
                                }
                                
                                yPos += 30; // Aumentato spazio per includere RM
                            });
                            
                            yPos += 8; // Spazio tra giorni
                        }
                    });
                }
                
                // === FOOTER MINIMALE ===
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    
                    doc.setDrawColor(220, 38, 38);
                    doc.setLineWidth(0.3);
                    doc.line(20, 285, 190, 285);
                    
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text("© Marius Constantin Simiras - Personal Trainer", 20, 290);
                    doc.text(`${i}/${pageCount}`, 190, 290, { align: 'right' });
                }
                
                // === SALVATAGGIO ===
                const fileName = `${client.nome}_${client.cognome}_Piano_Allenamento.pdf`;
                doc.save(fileName);
                
                showSuccessMessage(`📄 PDF generato: ${fileName}`);
                
            } catch (error) {
                console.error('Errore generazione PDF:', error);
                alert('Errore nella generazione del PDF. Riprova.');
            }
        }

        function loadWorkoutsList() {
            const workouts = loadData('workouts') || [];
            const clients = loadData('clients') || [];
            const container = document.getElementById('workoutPlansList');
            
            let filteredWorkouts = workouts;
            if (!isAdmin) {
                filteredWorkouts = workouts.filter(w => w.clientId === currentUser.id);
            }
            
            if (filteredWorkouts.length === 0) {
                container.innerHTML = `<p class="text-center text-gray py-8">
                    ${isAdmin ? 'Nessun piano allenamento creato' : 'Nessun piano allenamento assegnato'}
                </p>`;
                return;
            }
            
            container.innerHTML = filteredWorkouts.map(plan => {
                const client = clients.find(c => c.id === plan.clientId);
                if (!client) return '';
                
                // Raggruppa esercizi per giorno
                const exercisesByDay = {};
                if (plan.exercises) {
                    plan.exercises.forEach(exercise => {
                        if (!exercisesByDay[exercise.day]) {
                            exercisesByDay[exercise.day] = [];
                        }
                        exercisesByDay[exercise.day].push(exercise);
                    });
                }
                
                const dayOrder = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];
                
                return `
                    <div class="workout-plan">
                        <div class="plan-header">
                            <div>
                                <h3 class="plan-title">
                                    📋 Piano per ${client.nome} ${client.cognome}
                                </h3>
                                <div style="display: flex; gap: 20px; margin-top: 10px; font-size: 14px; color: #6b7280;">
                                    <span><i class="fas fa-calendar-alt" style="margin-right: 5px; color: #10b981;"></i>
                                          Inizio: ${new Date(plan.startDate).toLocaleDateString('it-IT')}</span>
                                    <span><i class="fas fa-calendar-check" style="margin-right: 5px; color: #dc2626;"></i>
                                          Fine: ${new Date(plan.endDate).toLocaleDateString('it-IT')}</span>
                                </div>
                            </div>
                            <div class="plan-actions">
                                <button class="btn btn-success" onclick="downloadPDF('${plan.id}')">
                                    <i class="fas fa-download"></i>
                                    Scarica PDF
                                </button>
                                ${isAdmin ? `
                                    <button class="btn btn-danger" onclick="deleteWorkoutPlan('${plan.id}')">
                                        <i class="fas fa-trash"></i>
                                        Elimina Piano
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${Object.keys(exercisesByDay).length > 0 ? `
                            <div class="days-container" style="margin-top: 25px;">
                                ${dayOrder.filter(day => exercisesByDay[day]).map(day => `
                                    <div class="day-section" style="margin-bottom: 30px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 15px; padding: 20px; border-left: 5px solid #3b82f6;">
                                        <h4 style="font-size: 20px; font-weight: bold; color: #1e3a8a; margin-bottom: 20px; display: flex; align-items: center;">
                                            <i class="fas fa-calendar-day" style="margin-right: 10px; color: #3b82f6;"></i>
                                            ${day}
                                            <span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">
                                                ${exercisesByDay[day].length} esercizi
                                            </span>
                                        </h4>
                                        
                                        <div class="exercises-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px;">
                                            ${exercisesByDay[day].map((exercise, index) => {
                                                const fcCalcolata = Math.round((exercise.frequenzaCardiaca / 100) * (client.fcMax || 0));
                                                return `
                                                    <div class="exercise-card" style="position: relative;">
                                                        <div class="exercise-number">${index + 1}</div>
                                                        <h5 class="exercise-title">${exercise.nome}</h5>
                                                        
                                                        <div class="exercise-details">
                                                            <div class="detail-item">
                                                                <span class="detail-label">Tipologia:</span>
                                                                <span>${exercise.tipologia}</span>
                                                            </div>
                                                            <div class="detail-item">
                                                                <span class="detail-label">Serie:</span>
                                                                <span>${exercise.serie}</span>
                                                            </div>
                                                            <div class="detail-item">
                                                                <span class="detail-label">Ripetizioni:</span>
                                                                <span>${exercise.ripetizioni}</span>
                                                            </div>
                                                            <div class="detail-item">
                                                                <span class="detail-label">Riposo:</span>
                                                                <span>${exercise.riposo} sec</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="heart-rate">
                                                            <i class="fas fa-heart heart-icon"></i>
                                                            <strong>Frequenza Cardiaca:</strong>
                                                            ${exercise.frequenzaCardiaca}% (${fcCalcolata} bpm)
                                                        </div>
                                                        
                                                        <div class="rm-section">
                                                            <i class="fas fa-weight-hanging rm-icon"></i>
                                                            <strong>% RM (Ripetizione Massimale):</strong>
                                                            ${exercise.percentualeRM || 70}%
                                                            <span class="rm-badge">${exercise.percentualeRM || 70}% RM</span>
                                                        </div>
                                                        
                                                        ${exercise.note ? `
                                                            <div class="notes-section">
                                                                <div class="notes-title">
                                                                    <i class="fas fa-sticky-note"></i>
                                                                    Note:
                                                                </div>
                                                                <p>${exercise.note}</p>
                                                            </div>
                                                        ` : ''}
                                                        
                                                        ${exercise.videoData ? `
                                                            <div class="video-section" style="margin-top: 15px; background: #dbeafe; border: 1px solid #93c5fd; border-radius: 8px; padding: 15px;">
                                                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                                                    <div style="display: flex; align-items: center;">
                                                                        <i class="fas fa-video" style="color: #1e40af; font-size: 18px; margin-right: 8px;"></i>
                                                                        <div>
                                                                            <strong style="color: #1e40af;">Video Dimostrativo</strong>
                                                                            <div style="font-size: 12px; color: #64748b;">
                                                                                ${exercise.videoData.name} (${(exercise.videoData.size / (1024 * 1024)).toFixed(1)} MB)
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    ${!isAdmin ? `
                                                                        <button class="btn" onclick="showVideoModal('${exercise.id}', '${exercise.nome}')" 
                                                                                style="background: #1e40af; color: white; padding: 8px 15px; font-size: 12px;">
                                                                            <i class="fas fa-play"></i>
                                                                            Guarda
                                                                        </button>
                                                                    ` : `
                                                                        <span style="color: #6b7280; font-size: 12px;">
                                                                            <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                                                            Video caricato
                                                                        </span>
                                                                    `}
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <p class="text-center text-gray py-8">Nessun esercizio ancora aggiunto</p>
                        `}
                    </div>
                `;
            }).join('');
        }

        // Funzione per mostrare video ai clienti - MIGLIORATA
        function showVideoModal(exerciseId, exerciseName) {
            const modal = document.getElementById('videoModal');
            const title = document.getElementById('videoTitle');
            const container = document.getElementById('videoContainer');
            
            title.textContent = exerciseName;
            
            // Trova il video nell'esercizio specifico
            const workouts = loadData('workouts') || [];
            let exerciseData = null;
            
            for (const workout of workouts) {
                if (workout.exercises) {
                    exerciseData = workout.exercises.find(ex => ex.id === exerciseId);
                    if (exerciseData) break;
                }
            }
            
            if (exerciseData && exerciseData.videoData) {
                // Mostra il video reale
                container.innerHTML = `
                    <div style="text-align: center;">
                        <video class="video-player" controls style="max-width: 100%; max-height: 70vh; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
                            <source src="${exerciseData.videoData.data}" type="${exerciseData.videoData.type}">
                            <p style="color: #dc2626; padding: 20px;">Il tuo browser non supporta la riproduzione video HTML5.</p>
                        </video>
                        <div style="margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <p style="font-size: 14px; color: #64748b; margin: 0;">
                                <i class="fas fa-info-circle" style="margin-right: 5px; color: #3b82f6;"></i>
                                <strong>File:</strong> ${exerciseData.videoData.name} | 
                                <strong>Dimensione:</strong> ${(exerciseData.videoData.size / (1024 * 1024)).toFixed(1)} MB
                            </p>
                        </div>
                    </div>
                `;
            } else {
                // Fallback se non trova il video
                container.innerHTML = `
                    <div class="video-placeholder">
                        <i class="fas fa-video"></i>
                        <h3 style="margin-bottom: 10px;">Video: ${exerciseName}</h3>
                        <p style="margin-bottom: 20px; opacity: 0.9;">Video non disponibile</p>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; max-width: 500px;">
                            <p style="font-size: 14px; line-height: 1.6;">
                                <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                                Il video per questo esercizio non è stato caricato o è stato rimosso.
                                Contatta il tuo trainer per maggiori informazioni.
                            </p>
                        </div>
                    </div>
                `;
            }
            
            modal.style.display = 'block';
            
            // Chiudi con ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeVideoModal();
                }
            });
        }

        function closeVideoModal() {
            const modal = document.getElementById('videoModal');
            const container = document.getElementById('videoContainer');
            
            modal.style.display = 'none';
            
            // Pausa tutti i video in riproduzione
            const videos = container.querySelectorAll('video');
            videos.forEach(video => {
                video.pause();
                video.currentTime = 0;
            });
            
            container.innerHTML = ''; // Pulisci il contenuto
        }

        // Chiudi modal cliccando fuori
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('videoModal');
            if (event.target === modal) {
                closeVideoModal();
            }
        });
    </script>
</body>
</html>